name: Linux

on:
  push:
    paths:
      - 'RTWLib_CLI/**'
      - 'RTWLib_Tests/**'
      - 'RTWLibPlus/**'
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
 
jobs:

    build-linux:
  
     runs-on: ubuntu-latest
     
     env:
      Solution_Name: '${{github.workspace}}/RTWLib_CLI/RTWLib_Solution.sln'                      # Replace with your solution name, i.e. MyWpfApp.sln.
      Test_Project_Path: '${{github.workspace}}/RTWLib_Tests/RTWLib_Tests.csproj'
      
     steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        
      - name: Install .NET Core Runtime
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '7.0.x'
          
      - name: Create Output Directory
        run: mkdir -p '${{github.workspace}}/RTWLib_Tests/bin/Debug/netcoreapp7.0/resources'

      - name: Copy Resources
        run: cp -r ./RTWLib_Tests/resources/. ${{ github.workspace }}/RTWLib_Tests/bin/Debug/netcoreapp7.0/resources/

      - name: List build output
        run: ls -R '${{github.workspace}}/RTWLib_Tests/bin/Debug/netcoreapp7.0'

      - name: Log files
        run: ls
      - name: pwd
        run: pwd

      - name: Restore packages
        run: dotnet restore ${{github.workspace}}/RTWLib_CLI/RTWLib_CLI.csproj

      - name: Build with dotnet
        run: dotnet build ${{github.workspace}}/RTWLib_CLI/RTWLib_CLI.csproj --configuration Release --no-restore

      - name: Run Tests
        run: dotnet test ${{ env.Test_Project_Path }}

      - name: Publish Build
        run: dotnet publish ./RTWLib_CLI/RTWLib_CLI.csproj -c Release -r linux-x64 --self-contained true -o ./publish/linux-x64

      - name: Publish Artifact
        uses: actions/upload-artifact@v2
        with:
          name: RTWRand-linux
          path:  ${{github.workspace}}/publish/linux-x64
